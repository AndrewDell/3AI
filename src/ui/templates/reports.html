<!DOCTYPE html>
<html lang="en">
<head>
    <!--
      📌 Reports Dashboard - 3AI
      ======================================
      This page provides a real-time view of AI agent performance,
      reports, and analytics.

      🔹 Features:
      - Live agent status updates via WebSockets.
      - Interactive agent performance charts using Chart.js.
      - Dynamic filtering and sorting for reports.
      - Expandable report details for better insights.

      🔹 Best Practices:
      - Uses semantic HTML for accessibility.
      - Implements modular layout for maintainability.
      - Fully responsive and mobile-friendly.

      ⏳ Last Updated: 2025-02-23
    -->

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="3AI Dashboard Reports - Analytics and performance metrics for AI agents">
    <title>Reports & Analytics - 3AI Dashboard</title>
    
    <!-- Preload critical assets -->
    <link rel="preload" href="/static/css/style.css" as="style">
    <link rel="preload" href="/static/js/main.js" as="script">
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/chart.js" as="script">

    <!-- 🔹 Stylesheets -->
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="stylesheet" href="/static/css/components.css">
    
    <!-- 🔹 Chart.js for Data Visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- 🔹 WebSockets for Live Agent Status -->
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const agentStatusContainer = document.getElementById("agent-status");
            const socket = new WebSocket("ws://localhost:8000/agent-status");

            socket.onmessage = (event) => {
                const agents = JSON.parse(event.data);
                agentStatusContainer.innerHTML = agents.map(agent => `
                    <div class="agent-card">
                        <strong>${agent.name}</strong> - <span class="${agent.status.toLowerCase()}">${agent.status}</span>
                    </div>
                `).join("");
            };

            socket.onerror = (error) => {
                console.error("WebSocket Error:", error);
            };
        });
    </script>

    <!-- Date Range Picker -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css">
</head>
<body>
    
    <!-- 🔹 Include the navigation/header component -->
    {% include 'partials/header.html' %}

    <main id="main-content" class="container mx-auto py-6" role="main">
        <!-- Page Header -->
        <div class="flex items-center justify-between mb-6">
            <div>
                <h1 class="text-2xl font-bold">Reports & Analytics</h1>
                <p class="text-muted">Detailed insights into agent performance and activities</p>
            </div>

            <!-- Export Actions -->
            <div class="flex gap-3">
                <button 
                    class="btn btn-outline"
                    onclick="exportReport('csv')"
                    aria-label="Export as CSV"
                >
                    Export CSV
                </button>
                <button 
                    class="btn btn-outline"
                    onclick="exportReport('pdf')"
                    aria-label="Export as PDF"
                >
                    Export PDF
                </button>
            </div>
        </div>

        <!-- Filters Section -->
        <section class="card mb-6" aria-labelledby="filters-title">
            <div class="card-header">
                <h2 id="filters-title" class="text-lg font-semibold">Filters</h2>
            </div>
            <div class="card-body">
                <form id="filters-form" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <!-- Date Range -->
                    <div class="form-group">
                        <label for="date-range" class="form-label">Date Range</label>
                        <input 
                            type="text" 
                            id="date-range" 
                            class="form-input"
                            placeholder="Select date range"
                        >
                    </div>

                    <!-- Agent Selection -->
                    <div class="form-group">
                        <label for="agent-filter" class="form-label">Agent</label>
                        <select id="agent-filter" class="form-input">
                            <option value="all">All Agents</option>
                            {% for agent in agents %}
                                <option value="{{ agent.id }}">{{ agent.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Status Filter -->
                    <div class="form-group">
                        <label for="status-filter" class="form-label">Status</label>
                        <select id="status-filter" class="form-input">
                            <option value="all">All Statuses</option>
                            <option value="success">Success</option>
                            <option value="error">Error</option>
                            <option value="warning">Warning</option>
                        </select>
                    </div>
                </form>
            </div>
        </section>

        <!-- Charts Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <!-- Performance Chart -->
            <section class="card" aria-labelledby="performance-title">
                <div class="card-header flex justify-between items-center">
                    <h2 id="performance-title" class="text-lg font-semibold">Performance Metrics</h2>
                    <button 
                        class="btn btn-outline btn-sm"
                        onclick="toggleChartView('performance')"
                    >
                        Toggle View
                    </button>
                </div>
                <div class="card-body">
                    <canvas 
                        id="performanceChart"
                        height="300"
                        aria-label="Agent performance metrics chart"
                    ></canvas>
                </div>
            </section>

            <!-- Error Rate Chart -->
            <section class="card" aria-labelledby="errors-title">
                <div class="card-header flex justify-between items-center">
                    <h2 id="errors-title" class="text-lg font-semibold">Error Analysis</h2>
                    <button 
                        class="btn btn-outline btn-sm"
                        onclick="toggleChartView('errors')"
                    >
                        Toggle View
                    </button>
                </div>
                <div class="card-body">
                    <canvas 
                        id="errorChart"
                        height="300"
                        aria-label="Error rate analysis chart"
                    ></canvas>
                </div>
            </section>
        </div>

        <!-- Detailed Reports Table -->
        <section class="card" aria-labelledby="reports-title">
            <div class="card-header flex justify-between items-center">
                <h2 id="reports-title" class="text-lg font-semibold">Detailed Reports</h2>
                <div class="flex items-center gap-2">
                    <input
                        type="search"
                        placeholder="Search reports..."
                        class="form-input"
                        aria-label="Search reports"
                        onkeyup="filterReports(this.value)"
                    >
                    <select 
                        class="form-input"
                        aria-label="Items per page"
                        onchange="updatePageSize(this.value)"
                    >
                        <option value="10">10 per page</option>
                        <option value="25">25 per page</option>
                        <option value="50">50 per page</option>
                    </select>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-container">
                    <table class="w-full" aria-label="Detailed agent reports">
                        <thead>
                            <tr>
                                <th scope="col" onclick="sortTable('timestamp')">Timestamp ↕</th>
                                <th scope="col" onclick="sortTable('agent')">Agent ↕</th>
                                <th scope="col" onclick="sortTable('action')">Action ↕</th>
                                <th scope="col" onclick="sortTable('status')">Status ↕</th>
                                <th scope="col" onclick="sortTable('duration')">Duration ↕</th>
                                <th scope="col">Details</th>
                            </tr>
                        </thead>
                        <tbody id="reports-table-body">
                            <!-- Reports will be dynamically inserted here -->
                            <tr>
                                <td colspan="6" class="text-center py-4 text-muted">
                                    Loading reports...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="card-footer">
                <div class="flex justify-between items-center">
                    <div class="text-sm text-muted">
                        Showing <span id="showing-range">0-0</span> of <span id="total-items">0</span> items
                    </div>
                    <div class="flex gap-2" id="pagination-controls">
                        <!-- Pagination will be dynamically inserted here -->
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- 🔹 Include Footer -->
    <footer role="contentinfo">
        <p>&copy; 2025 3AI. All rights reserved.</p>
    </footer>

    <!-- 🔹 JavaScript -->
    <script src="/static/js/main.js"></script>
    <script>
        /**
         * 📌 Chart.js - Agent Performance Visualization
         */
        const ctx = document.getElementById("agentChart").getContext("2d");
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ["SalesAgent", "MarketingAgent", "SupportAgent"],
                datasets: [{
                    label: "Tasks Completed",
                    data: [10, 15, 7],
                    backgroundColor: ["#007bff", "#28a745", "#dc3545"]
                }]
            }
        });

        /**
         * 📌 Function to Expand Report Details
         */
        function toggleDetails(row) {
            let nextRow = row.nextElementSibling;
            if (nextRow.classList.contains("details-row")) {
                nextRow.classList.toggle("show");
            }
        }
    </script>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
    <script type="module" src="/static/js/reports.js"></script>

    <!-- Initialize date range picker -->
    <script>
        $(document).ready(function() {
            $('#date-range').daterangepicker({
                startDate: moment().subtract(7, 'days'),
                endDate: moment(),
                ranges: {
                    'Today': [moment(), moment()],
                    'Yesterday': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
                    'Last 7 Days': [moment().subtract(6, 'days'), moment()],
                    'Last 30 Days': [moment().subtract(29, 'days'), moment()],
                    'This Month': [moment().startOf('month'), moment().endOf('month')],
                    'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]
                }
            }, function(start, end) {
                loadReports(start.format('YYYY-MM-DD'), end.format('YYYY-MM-DD'));
            });
        });
    </script>
</body>
</html>
